#!/bin/sh

# Flags to track failures
FAIL=0

echo "------------------------------------------------"
echo "Running Pre-commit Checks"
echo "------------------------------------------------"

# 1. Golang Checks
echo ">> Checking Go Backend..."

if command -v golangci-lint >/dev/null 2>&1; then
    golangci-lint run
    if [ $? -ne 0 ]; then
        echo "❌ Go linting failed"
        FAIL=1
    else
        echo "✅ Go linting passed"
    fi
else
    echo "⚠️ golangci-lint not found. Skipping Go linting."
    echo "   Please install it: https://golangci-lint.run/usage/install/"
fi

# 2. Frontend Checks
echo ""
echo ">> Checking Svelte Frontend..."

cd frontend || exit 1

echo "   Running svelte-check..."
npm run check
if [ $? -ne 0 ]; then
    echo "❌ Svelte check failed"
    FAIL=1
else
    echo "✅ Svelte check passed"
fi

echo "   Running ESLint..."
npm run lint
if [ $? -ne 0 ]; then
    echo "❌ ESLint failed"
    FAIL=1
else
    echo "✅ ESLint passed"
fi

echo "   Running Formatting Check..."
# Using prettier --check to verify files are formatted
npx prettier --check .
if [ $? -ne 0 ]; then
    echo "❌ Formatting issues found"
    echo "   Run 'npm run format' in the frontend directory to fix them."
    FAIL=1
else
    echo "✅ Formatting passed"
fi

echo "------------------------------------------------"

if [ $FAIL -ne 0 ]; then
    echo "❌ Pre-commit checks failed. Commit aborted."
    exit 1
fi

echo "✅ All checks passed. Proceeding with commit."
exit 0
